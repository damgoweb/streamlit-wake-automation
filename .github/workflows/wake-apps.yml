# .github/workflows/wake-apps.yml
name: Wake Streamlit Apps

# ãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š
on:
  # å®šæœŸå®Ÿè¡Œï¼ˆcronã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
  schedule:
    # 4æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆUTCæ™‚é–“ï¼‰
    # åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥
    - cron: '0 */4 * * *'
    # æ—¥æœ¬æ™‚é–“ã§è€ƒãˆã‚‹å ´åˆï¼š
    # - cron: '0 0,4,8,12,16,20 * * *'  # UTCï¼ˆæ—¥æœ¬æ™‚é–“-9æ™‚é–“ï¼‰
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  
  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã‚‚å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  TZ: 'Asia/Tokyo'
  PYTHON_VERSION: '3.9'

jobs:
  wake-streamlit-apps:
    name: Wake up Streamlit applications
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ6æ™‚é–“â†’30åˆ†ã«çŸ­ç¸®ï¼‰
    timeout-minutes: 30
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # å±¥æ­´ã‚’å–å¾—ï¼ˆãƒ­ã‚°ã®å·®åˆ†ç¢ºèªç”¨ï¼‰
          fetch-depth: 2
      
      # Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # pipä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      
      # Chromeãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ðŸŒ Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      # ChromeDriverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ðŸš— Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          
          # ChromeDriverã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          echo "Chrome version:"
          google-chrome --version
          echo "ChromeDriver version:"
          chromedriver --version
      
      # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰
      - name: ðŸ” Debug information
        if: ${{ github.event.inputs.debug_mode == 'true' }}
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in scripts/:"
          ls -la scripts/
          echo "Python version:"
          python --version
          echo "Installed packages:"
          pip list
      
      # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
      - name: ðŸš€ Wake up Streamlit apps
        id: wake_apps
        run: |
          python scripts/wake_apps.py
        continue-on-error: true  # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶šè¡Œ
      
      # å®Ÿè¡Œçµæžœã®ç¢ºèª
      - name: ðŸ“Š Check execution results
        if: always()
        run: |
          if [ -f logs/streamlit_access.log ]; then
            echo "ðŸ“‹ Latest log entries:"
            tail -n 20 logs/streamlit_access.log
          else
            echo "âš ï¸ Log file not found"
          fi
      
      # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: ðŸ’¾ Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wake-logs-${{ github.run_number }}
          path: logs/
          retention-days: 30
      
      # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ðŸ“ Commit log files
        if: ${{ success() && github.event_name != 'pull_request' }}
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
          git add logs/
          
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“ Update access logs [skip ci]"
            git push
          fi
      
      # Slackã¸ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - Slack WebhookãŒå¿…è¦ï¼‰
      - name: ðŸ“¢ Notify results to Slack
        if: ${{ failure() && github.event_name == 'schedule' }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Streamlitã‚¢ãƒ—ãƒªã®èµ·å‹•å‡¦ç†ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
      
      # å®Ÿè¡Œçµæžœã®ã‚µãƒžãƒªãƒ¼
      - name: ðŸ“ˆ Job Summary
        if: always()
        run: |
          echo "## å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œç•ªå·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f logs/streamlit_access.log ]; then
            echo "### æœ€æ–°ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 10 logs/streamlit_access.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
