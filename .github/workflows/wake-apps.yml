# .github/workflows/wake-apps.yml
name: Wake Streamlit Apps

on:
  schedule:
    - cron: '0 */4 * * *'  # 4æ™‚é–“ã”ã¨
  
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

env:
  TZ: 'Asia/Tokyo'
  PYTHON_VERSION: '3.9'

jobs:
  wake-streamlit-apps:
    name: Wake up Streamlit applications
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # é‡è¦: æ¨©é™ã‚’æ˜Žç¤ºçš„ã«è¨­å®š
    permissions:
      contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      actions: read    # Actionsã®èª­ã¿å–ã‚Šæ¨©é™
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆé‡è¦: tokenã‚’æŒ‡å®šï¼‰
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # GITHUB_TOKENã‚’æ˜Žç¤ºçš„ã«æŒ‡å®š
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # èªè¨¼æƒ…å ±ã‚’ä¿æŒ
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸŒ Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: ðŸš— Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          
          echo "Chrome version:"
          google-chrome --version
          echo "ChromeDriver version:"
          chromedriver --version
      
      - name: ðŸ” Debug information
        if: ${{ github.event.inputs.debug_mode == 'true' }}
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in scripts/:"
          ls -la scripts/
          echo "Python version:"
          python --version
          echo "Installed packages:"
          pip list
          echo "Git remote:"
          git remote -v
          echo "Git config:"
          git config --list
      
      - name: ðŸš€ Wake up Streamlit apps
        id: wake_apps
        run: |
          python scripts/wake_apps.py
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: ðŸ“Š Check execution results
        if: always()
        run: |
          if [ -f logs/streamlit_access.log ]; then
            echo "ðŸ“‹ Latest log entries:"
            tail -n 20 logs/streamlit_access.log
          else
            echo "âš ï¸ Log file not found"
          fi
          
          if [ "${{ steps.wake_apps.outputs.exit_code }}" = "0" ]; then
            echo "âœ… Script executed successfully"
          else
            echo "âš ï¸ Script exited with code: ${{ steps.wake_apps.outputs.exit_code }}"
          fi
      
      - name: ðŸ’¾ Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wake-logs-${{ github.run_number }}
          path: logs/
          retention-days: 30
      
      # ä¿®æ­£ç‰ˆ: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒŸãƒƒãƒˆ
      - name: ðŸ“ Commit and push log files
        if: ${{ github.event_name != 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Gitè¨­å®šï¼ˆbotã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼‰
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # èªè¨¼æƒ…å ±ã‚’è¨­å®š
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—
          git pull origin main || true
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ -f logs/streamlit_access.log ]; then
            git add logs/
            
            # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
            if git diff --staged --quiet; then
              echo "ðŸ“ No changes to commit"
            else
              # ã‚³ãƒŸãƒƒãƒˆ
              git commit -m "ðŸ“ Update access logs [skip ci]
              
              Run: #${{ github.run_number }}
              Time: $(date '+%Y-%m-%d %H:%M:%S %Z')" || true
              
              # ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
              for i in 1 2 3; do
                if git push origin main; then
                  echo "âœ… Successfully pushed to repository"
                  break
                else
                  echo "âš ï¸ Push failed, attempt $i/3"
                  if [ $i -lt 3 ]; then
                    sleep 5
                  fi
                fi
              done
            fi
          else
            echo "âš ï¸ No log file to commit"
          fi
      
      # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
      - name: ðŸ“¢ Notify results to Slack (Optional)
        if: ${{ failure() && github.event_name == 'schedule' && env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"âš ï¸ Streamlitã‚¢ãƒ—ãƒªã®èµ·å‹•å‡¦ç†ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ"}' \
              $SLACK_WEBHOOK_URL
          else
            echo "Slack webhook not configured, skipping notification"
          fi
        continue-on-error: true
      
      # ã‚¸ãƒ§ãƒ–ã‚µãƒžãƒªãƒ¼
      - name: ðŸ“ˆ Job Summary
        if: always()
        run: |
          echo "## å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œç•ªå·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f logs/streamlit_access.log ]; then
            echo "### æœ€æ–°ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 10 logs/streamlit_access.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi